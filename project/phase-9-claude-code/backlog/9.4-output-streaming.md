---
owner: bri
agent_flow: null
agent_status: idle
branch: null
risk: normal
review: not-requested
---

# 9.4 Output Streaming & Parsing

Summary:
Parse Claude Code's stream-json output for real-time UI updates during agent execution.

Acceptance Criteria:
- [ ] Parse newline-delimited JSON from stdout stream
- [ ] Create `ClaudeMessage` enum/types for different message kinds (assistant, tool_use, tool_result, result)
- [ ] Implement `AsyncStream<ClaudeMessage>` for UI consumption
- [ ] Buffer partial lines to handle chunked output
- [ ] Extract and expose: text content, tool calls, cost, duration
- [ ] Handle malformed JSON gracefully without crashing

Notes:
- Stream-json format: one JSON object per line
- Key message types: `assistant`, `user`, `tool_use`, `tool_result`, `result`
- Final `result` message contains `total_cost_usd` and `duration_ms`
- Use `JSONDecoder` with flexible decoding for unknown fields

History:
- 2025-11-29: Card created from Phase 9 planning.
