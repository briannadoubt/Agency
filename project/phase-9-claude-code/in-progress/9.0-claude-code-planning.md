---
owner: bri
agent_flow: null
agent_status: idle
branch: implement/9-0-claude-code-planning
risk: normal
review: not-requested
---

# 9.0 Claude Code Planning

Summary:
Plan integration with Claude Code CLI through the existing XPC worker architecture to enable agent-driven task execution directly from the Agency app.

Acceptance Criteria:
- [x] Document Phase 9 goals for Claude Code integration, including desired user flows and outcomes
- [x] Research existing XPC architecture and AgentExecutor pattern
- [x] Define follow-on cards for implementation phases
- [x] Capture dependencies/constraints (XPC workers, CLI discovery, API key management)
- [x] Define validation expectations with warnings-as-errors enabled

Notes:
- Claude Code is Anthropic's official CLI for Claude, providing agentic coding capabilities.
- Integration follows existing XPC architecture: App → CodexSupervisor → Worker → `claude` CLI.
- Worker process spawns `claude` CLI, streams output back to app via log file.
- Mirrors the pattern used by `CLIPhaseExecutor` and `CodexAgentExecutor`.

---

## Phase 9 Goals

### Vision
Enable Agency users to run Claude Code sessions on task cards through the existing XPC worker infrastructure. The worker process spawns the `claude` CLI in headless mode, streaming output back to the app for real-time progress display.

### Desired User Flows & Outcomes

1. **Card-driven agent execution**: Select a backlog card → "Run with Claude Code" → XPC worker spawns `claude -p` with card context → agent implements the card's requirements.
2. **Progress visibility**: Worker streams `claude` output to log file, app tails log and displays in UI.
3. **Isolated execution**: Each Claude Code session runs in its own XPC worker process, with crash isolation.
4. **Branch automation**: Agent creates implementation branch, moves card to in-progress, works through acceptance criteria.
5. **Review handoff**: When worker exits successfully, prompt user to review before marking done.

### Architecture Overview

```
┌─────────────┐     ┌──────────────────┐     ┌─────────────────┐     ┌─────────────┐
│  Agency App │────▶│ CodexSupervisor  │────▶│  XPC Worker     │────▶│ claude CLI  │
│             │◀────│      .xpc        │◀────│   (Process)     │◀────│  (headless) │
└─────────────┘     └──────────────────┘     └─────────────────┘     └─────────────┘
      │                                              │
      │                                              ▼
      │                                       ┌─────────────┐
      └──────────────────────────────────────▶│ worker.log  │
                   (tail log file)            └─────────────┘
```

### Integration Points

| Component | Role |
|-----------|------|
| `AgentRunner` | Orchestrates runs, selects `.claudeCode` backend |
| `ClaudeCodeExecutor` | New `AgentExecutor` conformer for Claude Code |
| `CodexWorkerRuntime` | Extended to support `claude` CLI spawning |
| `WorkerLogStreamer` | Existing log streaming, no changes needed |
| `AgentBackendKind` | Add `.claudeCode` case |

---

## Claude Code CLI Integration

### Invocation from Worker

Worker process (`CodexWorkerRuntime`) spawns `claude` CLI:

```swift
let process = Process()
process.executableURL = URL(fileURLWithPath: claudePath)
process.currentDirectoryURL = projectRoot
process.environment = ["ANTHROPIC_API_KEY": apiKey]
process.arguments = [
    "-p", prompt,
    "--output-format", "stream-json",
    "--allowedTools", "Bash,Read,Write,Edit,Glob,Grep",
    "--max-turns", "50"
]
```

### Output Handling

- Worker redirects `claude` stdout to log file
- Uses existing `WorkerLogStreamer` to tail log
- Parses stream-json for progress events
- Emits `WorkerLogEvent` messages to app

### Key CLI Arguments

| Argument | Purpose |
|----------|---------|
| `-p, --print` | Headless/non-interactive mode |
| `--output-format stream-json` | Real-time JSON output for parsing |
| `--allowedTools` | Pre-authorize tools (Bash, Read, Write, etc.) |
| `--max-turns` | Limit agentic iterations (default 50) |

---

## Follow-on Cards

### 9.1 ClaudeCodeLocator & Settings
- Implement `ClaudeCodeLocator` to find `claude` binary
- Check PATH, common locations (`/usr/local/bin`, `~/.local/bin`)
- Add Settings UI for custom binary path override
- Store/retrieve settings via UserDefaults

### 9.2 API Key Management
- Implement `ClaudeKeyManager` using macOS Keychain
- Add Settings UI for entering/updating API key
- Validate key format (starts with `sk-ant-`)
- Pass key to worker via environment/payload

### 9.3 ClaudeCodeExecutor
- Create `ClaudeCodeExecutor` conforming to `AgentExecutor`
- Add `.claudeCode` case to `AgentBackendKind`
- Build `CodexRunRequest` with Claude-specific `cliArgs`
- Register executor in `AgentRunner`

### 9.4 Worker Runtime Extension
- Extend `CodexWorkerRuntime` to spawn `claude` process
- Read API key from environment (passed by supervisor)
- Stream `claude` output to worker.log
- Handle process lifecycle (start, monitor, cleanup)

### 9.5 Output Parsing & Progress
- Parse stream-json output for message types
- Extract tool calls, assistant messages, cost info
- Map to existing `WorkerLogEvent` format
- Display structured output in UI

### 9.6 UI Integration
- Add "Run with Claude Code" button to card detail
- Show Claude Code as backend option in agent run UI
- Display real-time streaming output
- Show cost accumulation from stream-json

### 9.7 Testing & Polish
- Unit tests for `ClaudeCodeLocator`, `ClaudeKeyManager`
- Integration tests with mock `claude` script
- Verify warnings-as-errors compliance
- Update AGENTS.md and README.md

---

## Dependencies & Constraints

### System Requirements
- macOS 13.0+ (existing XPC infrastructure)
- Claude Code CLI installed (`npm install -g @anthropic-ai/claude-code`)
- Valid Anthropic API key

### Security Model
- API key stored in Keychain (never plaintext)
- Key passed to worker via secure environment variable
- Worker runs in sandbox with project bookmark access
- CLI tool allowlist limits agent capabilities

### Existing Infrastructure Reuse
- `CodexSupervisor` / XPC worker pipeline - unchanged
- `WorkerLogStreamer` - unchanged
- `AgentRunner` - add new backend kind
- `CodexRunRequest` - use existing `cliArgs` field

### Entitlements
- No new entitlements required
- Uses existing XPC and file access entitlements

---

## Validation Expectations

### Build Requirements
- Zero warnings with `SWIFT_TREAT_WARNINGS_AS_ERRORS = YES`
- All new code compiles cleanly on macOS 26 SDK

### Test Coverage
- Unit tests for `ClaudeCodeLocator`, `ClaudeKeyManager`
- Unit tests for `ClaudeCodeExecutor` with mock worker
- Integration tests with mock `claude` shell script
- Test error paths (missing CLI, invalid key, process failure)

### Quality Standards
- Swift Concurrency only (no DispatchQueues per AGENTS.md)
- `@MainActor` for UI-related operations
- `@Observable` for state management
- Follow existing code patterns from `CLIPhaseExecutor`

---

History:
- 2025-11-29: Card created for Phase 9 planning.
- 2025-11-29: Revised plan to integrate with existing XPC architecture.
