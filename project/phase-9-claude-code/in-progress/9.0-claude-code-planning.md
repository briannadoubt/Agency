---
owner: bri
agent_flow: null
agent_status: idle
branch: implement/9-0-claude-code-planning
risk: normal
review: not-requested
---

# 9.0 Claude Code Planning

Summary:
Plan integration with Claude Code CLI to enable agent-driven task execution directly from the Agency app.

Acceptance Criteria:
- [x] Document Phase 9 goals for Claude Code integration, including desired user flows and outcomes
- [x] Research Claude Code CLI capabilities, arguments, and output formats
- [x] Define follow-on cards for implementation phases
- [x] Capture dependencies/constraints (CLI location, environment, permissions)
- [x] Define validation expectations with warnings-as-errors enabled

Notes:
- Claude Code is Anthropic's official CLI for Claude, providing agentic coding capabilities.
- Integration should allow spawning Claude Code sessions from cards with context.
- Consider security implications of executing external CLI tools.

---

## Phase 9 Goals

### Vision
Enable Agency users to spawn Claude Code sessions directly from task cards, allowing AI-assisted implementation of kanban items with full context awareness of the card's acceptance criteria, project structure, and workflow conventions.

### Desired User Flows & Outcomes

1. **Card-driven agent execution**: Select a backlog card → "Run with Claude Code" → agent implements the card's requirements using the documented workflow.
2. **Progress visibility**: Stream Claude Code output in a terminal-like view within Agency, showing tool calls, edits, and reasoning.
3. **Session management**: Pause/resume agent sessions, view history, and track costs per card.
4. **Branch automation**: Agent creates implementation branch, moves card to in-progress, and works through acceptance criteria.
5. **Review handoff**: When agent completes, prompt user to review before moving card to done.

### Core Features to Implement

| Feature | Description | Priority |
|---------|-------------|----------|
| CLI Discovery | Locate `claude` binary and verify version | P0 |
| API Key Management | Securely store/retrieve Anthropic API key via Keychain | P0 |
| Headless Execution | Spawn `claude -p` with card context and project path | P0 |
| Output Streaming | Parse stream-json output for real-time UI updates | P1 |
| Session Persistence | Track session IDs for resume capability | P1 |
| Cost Tracking | Display and log per-card API costs | P2 |
| Custom CLAUDE.md | Generate card-specific context file for agent | P2 |

---

## Claude Code CLI Research Summary

### Invocation Patterns

**Headless mode (primary integration point):**
```bash
claude -p "Your task description" \
    --output-format stream-json \
    --allowedTools "Bash,Read,Write,Edit,Glob,Grep" \
    --max-turns 50
```

### Key Arguments

| Argument | Purpose |
|----------|---------|
| `-p, --print` | Headless/non-interactive mode |
| `--output-format` | `text`, `json`, or `stream-json` |
| `--allowedTools` | Pre-authorize tools without prompting |
| `--max-turns` | Limit agentic iterations |
| `--model` | Specify model (`sonnet`, `opus`) |
| `-c, --continue` | Resume most recent session |
| `-r, --resume <id>` | Resume specific session by ID |
| `--add-dir` | Include additional working directories |

### Output Formats

**JSON (final result):**
```json
{
  "type": "result",
  "result": "response text",
  "total_cost_usd": 0.003,
  "duration_ms": 1234
}
```

**Stream-JSON (real-time):**
Emits individual messages as newline-delimited JSON, enabling live UI updates.

### Environment Requirements

- `ANTHROPIC_API_KEY` environment variable for API access
- Working directory set to project root
- `claude` binary in PATH (typically `/usr/local/bin/claude` or `~/.local/bin/claude`)

---

## Follow-on Cards

### 9.1 CLI Discovery & Validation
- Implement `ClaudeCodeLocator` to find `claude` binary
- Check PATH, common locations (`/usr/local/bin`, `~/.local/bin`, Homebrew)
- Verify minimum version compatibility
- Surface errors in UI if CLI not found
- Add Settings UI for custom binary path override

### 9.2 API Key Management
- Implement `ClaudeKeyManager` using macOS Keychain
- Add Settings UI for entering/updating API key
- Validate key format and test connectivity
- Securely pass key to subprocess via environment
- Handle missing/invalid key errors gracefully

### 9.3 Process Spawning & Execution
- Create `ClaudeCodeRunner` actor for subprocess management
- Set working directory to project root
- Build argument list from card context
- Implement process lifecycle (start, cancel, cleanup)
- Handle exit codes and error conditions

### 9.4 Output Streaming & Parsing
- Parse stream-json output line by line
- Create `ClaudeMessage` types for different message kinds
- Implement async stream for UI consumption
- Buffer partial lines for robust parsing
- Extract tool calls, responses, and assistant messages

### 9.5 Agent Session UI
- Add "Run with Agent" button to card detail view
- Create `AgentSessionView` with terminal-like output display
- Show progress indicators and current tool being used
- Display cost accumulation in real-time
- Add cancel button with confirmation

### 9.6 Session Persistence & Resume
- Store session IDs with card metadata
- Implement resume capability using `--resume` flag
- Track session state (running, paused, completed, failed)
- Clean up stale sessions on app launch
- Add session history view per card

### 9.7 Testing & Polish
- Unit tests for CLI locator, key manager, output parser
- Integration tests with mock claude binary
- Verify warnings-as-errors compliance
- Update AGENTS.md and README.md with Claude Code docs
- Add user-facing error messages for common issues

---

## Dependencies & Constraints

### System Requirements
- macOS 13.0+ (for modern Process API features)
- Claude Code CLI installed (`npm install -g @anthropic-ai/claude-code`)
- Valid Anthropic API key with sufficient credits

### Security Considerations
- API key stored in Keychain, never in plaintext or UserDefaults
- Subprocess runs with user's permissions (no elevation)
- Working directory constrained to project path
- Tool allowlist limits agent capabilities

### Entitlements
- No new entitlements required (inherits app sandbox permissions)
- If sandboxed: may need `com.apple.security.temporary-exception.files.absolute-path.read-write` for project access

### Integration Points
- `ProjectLoader` for card/phase context
- `CardMover` for automated card transitions
- Existing git operations for branch creation
- `CLAUDE.md` at project root for agent context

---

## Validation Expectations

### Build Requirements
- Zero warnings with `SWIFT_TREAT_WARNINGS_AS_ERRORS = YES`
- All new code compiles cleanly on macOS 26 SDK

### Test Coverage
- Unit tests for `ClaudeCodeLocator`, `ClaudeKeyManager`, `ClaudeCodeRunner`
- Mock subprocess output for parser tests
- Test error paths (missing CLI, invalid key, process failure)
- UI tests for agent session flow where feasible

### Quality Standards
- Swift Concurrency only (no DispatchQueues)
- `@MainActor` for UI-related operations
- `@Observable` for state management
- Proper error handling with user-friendly messages

---

History:
- 2025-11-29: Card created for Phase 9 planning.
- 2025-11-29: Completed research and full phase planning with 7 follow-on cards.
