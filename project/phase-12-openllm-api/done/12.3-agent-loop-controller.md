---
owner: claude
agent_flow: implement
agent_status: succeeded
branch: claude/complete-phase-12-1Ebkk
risk: high
review: not-requested
---

# 12.3 Agent Loop Controller

Summary:
Implement the agentic loop for HTTP providers that handles multi-turn conversations with tool use, since HTTP APIs don't include their own agent loop like Claude Code CLI.

Acceptance Criteria:
- [x] Create `AgentLoopController` actor for managing agent execution
- [x] Build initial system prompt using existing `PromptBuilder`
- [x] Implement conversation state management (messages array)
- [x] Parse model responses for tool calls vs. text output
- [x] Route tool calls to `ToolExecutionBridge` (card 12.4)
- [x] Append tool results to conversation and continue loop
- [x] Implement max turns limit with configurable threshold
- [x] Handle completion detection (no tool calls, done signal)
- [x] Emit progress events for UI streaming display
- [x] Support cancellation via Task cancellation
- [x] Unit tests for loop logic with mock provider

Notes:
- This is the core logic that makes HTTP providers agentic
- Must handle both streaming and non-streaming responses
- Tool execution should be async and potentially parallel for independent tools
- Consider conversation pruning for context length limits
- Map to existing `WorkerLogEvent` format for UI consistency

History:
- 2025-12-18: Card created from Phase 12 planning.
- 2025-12-20: Implemented AgentLoopController actor with full conversation management, streaming support, tool routing, context pruning, and cancellation support.
