---
owner: null
agent_flow: null
agent_status: idle
branch: null
risk: high
review: not-requested
---

# 12.3 Agent Loop Controller

Summary:
Implement the agentic loop for HTTP providers that handles multi-turn conversations with tool use, since HTTP APIs don't include their own agent loop like Claude Code CLI.

Acceptance Criteria:
- [ ] Create `AgentLoopController` actor for managing agent execution
- [ ] Build initial system prompt using existing `PromptBuilder`
- [ ] Implement conversation state management (messages array)
- [ ] Parse model responses for tool calls vs. text output
- [ ] Route tool calls to `ToolExecutionBridge` (card 12.4)
- [ ] Append tool results to conversation and continue loop
- [ ] Implement max turns limit with configurable threshold
- [ ] Handle completion detection (no tool calls, done signal)
- [ ] Emit progress events for UI streaming display
- [ ] Support cancellation via Task cancellation
- [ ] Unit tests for loop logic with mock provider

Notes:
- This is the core logic that makes HTTP providers agentic
- Must handle both streaming and non-streaming responses
- Tool execution should be async and potentially parallel for independent tools
- Consider conversation pruning for context length limits
- Map to existing `WorkerLogEvent` format for UI consistency

History:
- 2025-12-18: Card created from Phase 12 planning.
