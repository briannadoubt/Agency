name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  tests:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Create simulator
        id: sim
        run: |
          set -eo pipefail

          # Prefer iPhone 15, otherwise fall back to the first iPhone type available.
          DEVICE_TYPE=$(xcrun simctl list devicetypes | grep "iPhone 15" | head -n1 | awk -F'[()]' '{print $2}')
          if [ -z "$DEVICE_TYPE" ]; then
            DEVICE_TYPE=$(xcrun simctl list devicetypes | grep "iPhone" | head -n1 | awk -F'[()]' '{print $2}')
          fi

          # Use the newest available iOS runtime.
          RUNTIME=$(xcrun simctl list runtimes | grep "iOS" | grep "available" | head -n1 | awk -F'[()]' '{print $2}')

          UDID=$(xcrun simctl create "CI-iPhone" "$DEVICE_TYPE" "$RUNTIME")
          echo "udid=$UDID" >> "$GITHUB_OUTPUT"
          echo "device_type=$DEVICE_TYPE" >> "$GITHUB_OUTPUT"
          echo "runtime=$RUNTIME" >> "$GITHUB_OUTPUT"

      - name: Boot simulator
        run: xcrun simctl boot "${{ steps.sim.outputs.udid }}"

      - name: Run tests
        run: |
          set -eo pipefail
          xcodebuild \
            -project Agency.xcodeproj \
            -scheme Agency \
            -destination "platform=iOS Simulator,id=${{ steps.sim.outputs.udid }}" \
            test

      - name: Shutdown simulator
        if: always()
        run: xcrun simctl shutdown "${{ steps.sim.outputs.udid }}"
